<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯å¤šåŠŸèƒ½ç­†è¨˜ - LAN Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #ffd966; --bg: #1d1d1d; --card: #2d2d2d; --danger: #e74c3c; }
        
        body { 
            background-color: var(--bg); 
            color: white; 
            margin: 0; 
            font-family: 'Noto Sans TC', sans-serif;
        }

        /* å°è¦½åˆ—é ç•™ç©ºé–“ */
        .main-layout { 
            display: flex; 
            max-width: 1200px; 
            margin: 100px auto 40px; 
            gap: 20px; 
            padding: 0 20px; 
            height: calc(100vh - 150px); 
        }
        
        /* å·¦å´ç­†è¨˜æ¸…å–® */
        .sidebar { 
            width: 280px; 
            background: var(--card); 
            border-radius: 12px; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            border: 1px solid #333;
        }
        .sidebar-header { 
            padding: 15px; 
            background: #333; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--gold);
        }
        .add-btn { 
            cursor: pointer; 
            color: var(--gold); 
            font-size: 1.5rem; 
            background: none; 
            border: none; 
            transition: 0.3s;
        }
        .add-btn:hover { transform: scale(1.2); }

        #note-list { flex: 1; overflow-y: auto; list-style: none; margin: 0; padding: 0; }
        #note-list li { 
            padding: 15px; 
            border-bottom: 1px solid #3d3d3d; 
            cursor: pointer; 
            transition: 0.3s;
            font-size: 0.95rem;
            color: #bbb;
        }
        #note-list li:hover { background: #3d3d3d; color: white; }
        #note-list li.active { 
            border-left: 4px solid var(--gold); 
            background: #3d3d3d; 
            color: var(--gold);
            font-weight: bold;
        }

        /* å³å´ç·¨è¼¯å™¨ */
        .editor-area { 
            flex: 1; 
            background: var(--card); 
            border-radius: 12px; 
            display: flex; 
            flex-direction: column; 
            padding: 25px; 
            position: relative; 
            border: 1px solid #333;
        }
        .toolbar { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px; 
            border-bottom: 1px solid #444; 
            padding-bottom: 15px;
            align-items: center;
        }
        .toolbar button { 
            background: #444; 
            border: none; 
            color: white; 
            padding: 6px 12px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.9rem;
            transition: 0.2s;
        }
        .toolbar button:hover { background: var(--gold); color: black; }
        .btn-delete { margin-left: auto; background: var(--danger) !important; }
        .btn-delete:hover { background: #c0392b !important; color: white !important; }

        #editor-title { 
            background: transparent; 
            border: none; 
            color: var(--gold); 
            font-size: 1.8rem; 
            font-weight: bold; 
            outline: none; 
            margin-bottom: 15px; 
            width: 100%;
        }
        #editor-body { 
            flex: 1; 
            background: transparent; 
            border: none; 
            color: #ddd; 
            outline: none; 
            overflow-y: auto; 
            line-height: 1.8; 
            font-size: 1.1rem;
        }
        #editor-body[contenteditable]:empty:before { 
            content: "åœ¨é€™è£¡è¼¸å…¥å…§å®¹..."; 
            color: #666; 
        }

        #save-indicator { 
            position: absolute; 
            bottom: 15px; 
            right: 25px; 
            font-size: 0.75rem; 
            color: #555; 
        }
        
        #login-overlay { 
            text-align: center; 
            margin-top: 150px; 
            color: var(--gold); 
        }

        /* æ²è»¸ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1d1d1d; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="main-layout" id="main-ui" style="display: none;">
        <div class="sidebar">
            <div class="sidebar-header">
                <span style="font-weight: bold; letter-spacing: 1px;">æˆ‘çš„ç­†è¨˜</span>
                <button class="add-btn" id="add-note-btn" title="æ–°å¢ç­†è¨˜">+</button>
            </div>
            <ul id="note-list">
                </ul>
        </div>

        <div class="editor-area" id="editor-container" style="visibility: hidden;">
            <div class="toolbar">
                <button onclick="execCmd('bold')" title="ç²—é«”"><b>B</b></button>
                <button onclick="execCmd('italic')" title="æ–œé«”"><i>I</i></button>
                <button onclick="execCmd('createLink', prompt('è«‹è¼¸å…¥é€£çµç¶²å€:', 'https://'))">ğŸ”— é€£çµ</button>
                <button onclick="execCmd('unlink')">ç§»é™¤é€£çµ</button>
                <button onclick="deleteCurrentNote()" class="btn-delete">ğŸ—‘ï¸ åˆªé™¤ç­†è¨˜</button>
            </div>
            <input type="text" id="editor-title" placeholder="ç„¡æ¨™é¡Œç­†è¨˜">
            <div id="editor-body" contenteditable="true"></div>
            <div id="save-indicator">å·²åŒæ­¥è‡³é›²ç«¯</div>
        </div>
        
        <div id="no-note-selected" style="flex:1; display:flex; justify-content:center; align-items:center; color:#555;">
            <h3>è«‹é¸æ“‡æˆ–æ–°å¢ä¸€ä»½ç­†è¨˜</h3>
        </div>
    </div>

    <div id="login-overlay" style="display: none;">
        <h2>ğŸ” è«‹å…ˆç™»å…¥ä»¥ä½¿ç”¨é›²ç«¯å¤šåŠŸèƒ½ç­†è¨˜</h2>
        <p>ç™»å…¥å¾Œå³å¯åŒæ­¥æ‚¨çš„æ‰€æœ‰å…§å®¹</p>
    </div>

    <script type="module">
        import { auth } from "./navbar.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, where, orderBy, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const db = getFirestore();
        let currentNoteId = null;
        let saveTimeout = null;

        // å¯Œæ–‡æœ¬æŒ‡ä»¤å·¥å…·
        window.execCmd = (cmd, val = null) => {
            if (!currentNoteId) return;
            document.execCommand(cmd, false, val);
            saveData();
        };

        // ç›£è½ç™»å…¥ç‹€æ…‹
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('main-ui').style.display = 'flex';
                document.getElementById('login-overlay').style.display = 'none';
                loadNoteList(user.uid);
            } else {
                document.getElementById('main-ui').style.display = 'none';
                document.getElementById('login-overlay').style.display = 'block';
            }
        });

        // 1. è¼‰å…¥é›²ç«¯ç­†è¨˜æ¸…å–®
        function loadNoteList(uid) {
            const q = query(collection(db, "notes"), where("uid", "==", uid), orderBy("updatedAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('note-list');
                listEl.innerHTML = "";
                
                if (snapshot.empty) {
                    listEl.innerHTML = '<li style="text-align:center; color:#555;">å°šç„¡ç­†è¨˜</li>';
                    return;
                }

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    li.innerText = data.title || "ç„¡æ¨™é¡Œç­†è¨˜";
                    if (doc.id === currentNoteId) li.className = "active";
                    
                    li.onclick = () => selectNote(doc.id, data);
                    listEl.appendChild(li);
                });
            });
        }

        // 2. é¸æ“‡ä¸¦é¡¯ç¤ºç­†è¨˜å…§å®¹
        function selectNote(id, data) {
            currentNoteId = id;
            document.getElementById('no-note-selected').style.display = 'none';
            document.getElementById('editor-container').style.visibility = 'visible';
            
            document.getElementById('editor-title').value = data.title || "";
            document.getElementById('editor-body').innerHTML = data.content || "";
            
            // æ›´æ–°æ¸…å–®é¸å–ç‹€æ…‹
            const items = document.querySelectorAll('#note-list li');
            items.forEach(li => {
                li.classList.remove('active');
                if (li.innerText === (data.title || "ç„¡æ¨™é¡Œç­†è¨˜")) li.classList.add('active');
            });
        }

        // 3. æ–°å¢ç­†è¨˜
        document.getElementById('add-note-btn').onclick = async () => {
            if (!auth.currentUser) return;
            const newNoteRef = doc(collection(db, "notes"));
            const newData = {
                uid: auth.currentUser.uid,
                title: "æ–°ç­†è¨˜",
                content: "",
                updatedAt: serverTimestamp()
            };
            await setDoc(newNoteRef, newData);
            selectNote(newNoteRef.id, newData);
        };

        // 4. è‡ªå‹•å„²å­˜é‚è¼¯ (åœæ­¢è¼¸å…¥ 1 ç§’å¾Œè§¸ç™¼)
        function saveData() {
            if (!currentNoteId || !auth.currentUser) return;
            
            document.getElementById('save-indicator').innerText = "â³ æ­£åœ¨åŒæ­¥è‡³é›²ç«¯...";
            
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                const docRef = doc(db, "notes", currentNoteId);
                try {
                    await setDoc(docRef, {
                        title: document.getElementById('editor-title').value,
                        content: document.getElementById('editor-body').innerHTML,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    document.getElementById('save-indicator').innerText = "âœ… å·²åŒæ­¥è‡³é›²ç«¯";
                } catch (e) {
                    document.getElementById('save-indicator').innerText = "âŒ å„²å­˜å¤±æ•—";
                }
            }, 1000);
        }

        // 5. åˆªé™¤ç•¶å‰ç­†è¨˜
        window.deleteCurrentNote = async () => {
            if (!currentNoteId) return;
            if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ä»½ç­†è¨˜å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•é‚„åŸã€‚")) {
                const idToDelete = currentNoteId;
                currentNoteId = null;
                
                document.getElementById('editor-container').style.visibility = 'hidden';
                document.getElementById('no-note-selected').style.display = 'flex';
                
                await deleteDoc(doc(db, "notes", idToDelete));
            }
        };

        // ç›£è½è¼¸å…¥äº‹ä»¶
        document.getElementById('editor-title').oninput = saveData;
        document.getElementById('editor-body').oninput = saveData;
    </script>

    <script type="module" src="./navbar.js"></script>
</body>
</html>
