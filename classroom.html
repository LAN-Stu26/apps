<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom - LAN Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        html, body { height: 100%; margin: 0; }
        body {
            display: flex;
            flex-direction: column;
            background-color: #1d1d1d;
            color: #ffffff;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .content-wrapper {
            flex: 1 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            box-sizing: border-box;
        }

        .container { max-width: 900px; width: 100%; margin-top: 20px; }

        .main-display {
            background: #252526;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            border: 2px solid #ffd966;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 30px;
            min-height: 280px;
        }

        #result-area {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 25px 0;
        }

        .number-circle {
            width: 110px;
            height: 110px;
            background: #1a1a1a;
            border: 4px solid #ffd966;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            font-weight: bold;
            color: #ffd966;
            box-shadow: 0 0 15px rgba(255, 217, 102, 0.3);
        }

        .history-tag {
            font-size: 0.85rem;
            color: #666;
            margin-top: 10px;
        }

        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 50px;
        }

        .card { background: #252526; padding: 20px; border-radius: 12px; border: 1px solid #3c3c3c; }
        h3 { color: #ffd966; margin-top: 0; border-bottom: 1px solid #3c3c3c; padding-bottom: 10px; font-size: 1.1rem; }
        label { display: block; margin: 12px 0 5px; font-size: 0.85rem; color: #aaa; }
        
        input, select {
            width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #3c3c3c;
            color: white; border-radius: 6px; box-sizing: border-box; font-size: 1rem;
        }

        .btn-draw {
            width: 100%; max-width: 320px; padding: 18px; background: #ffd966;
            color: black; border: none; border-radius: 12px; font-size: 1.3rem;
            font-weight: bold; cursor: pointer; transition: 0.3s;
        }

        .btn-draw:hover { background: #f0c95a; transform: translateY(-3px); }
        
        .btn-reset {
            background: transparent; color: #ff6666; border: 1px solid #ff6666;
            padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; margin-top: 10px;
        }
        .btn-reset:hover { background: #ff6666; color: white; }

        .method-info { font-size: 1rem; color: #ffd966; margin-bottom: 15px; font-weight: bold; }

        /* åˆ‡æ›é–‹é—œæ¨£å¼ */
        .switch-box { display: flex; align-items: center; justify-content: space-between; margin-top: 10px; }
    </style>
</head>
<body>

    <script type="module" src="/navbar.js"></script>

    <div class="content-wrapper">
        <div class="container">
            <div class="main-display">
                <div id="method-display" class="method-info">æº–å‚™å°±ç·’</div>
                <div id="result-area">
                    <div class="number-circle">?</div>
                </div>
                <button class="btn-draw" onclick="luckyDraw()">é–‹å§‹åŒæ™‚æŠ½å–</button>
                <div class="history-tag">
                    å·²æŠ½å‡ºäººæ•¸ï¼š<span id="history-count">0</span> 
                    <button class="btn-reset" onclick="resetHistory()">é‡ç½®æ­·å²ç´€éŒ„</button>
                </div>
            </div>

            <div class="control-panel">
                <div class="card">
                    <h3>ğŸ‘¥ ç­ç´šè¨­å®š</h3>
                    <label>å…¨ç­ç¸½äººæ•¸</label>
                    <input type="number" id="total-students" value="30" min="1">
                    <label>ç¼ºå¸­åº§è™Ÿ (ç”¨é€—è™Ÿéš”é–‹)</label>
                    <input type="text" id="absent-list" placeholder="ä¾‹å¦‚: 3, 12">
                    <label>æœ¬æ¬¡æŠ½å–äººæ•¸</label>
                    <input type="number" id="draw-count" value="1" min="1" max="10">
                    
                    <div class="switch-box">
                        <label style="margin:0;">æ’é™¤å·²æŠ½éçš„äºº</label>
                        <input type="checkbox" id="exclude-history" style="width:20px; height:20px;">
                    </div>
                </div>

                <div class="card">
                    <h3>âš–_ è¦å‰‡é¸æ“‡</h3>
                    <select id="draw-rule" style="margin-top: 15px;">
                        <option value="random">1. ç´”ç²¹éš¨æ©Ÿ (çµ•å°å…¬å¹³)</option>
                        <option value="date">2. å°ç£è€å¸«æ³• (æ—¥æœŸé­”æ³•)</option>
                        <option value="second">3. ç§’æ•¸æ±ºå®šæ³• (å‘½é‹ä¸€ç¬é–“)</option>
                    </select>
                </div>

                <div class="card">
                    <h3>ğŸ¯ å¼·åˆ¶åŠ æ¬Š</h3>
                    <label>å„ªå…ˆæŠ½ä¸­å€é–“ (å¦‚ 1-10)</label>
                    <input type="text" id="priority-range" placeholder="ä¾‹å¦‚: 1-5">
                    <label>åŠ æ¬Šå€æ•¸</label>
                    <select id="priority-weight">
                        <option value="1">æ­£å¸¸ (1x)</option>
                        <option value="10">æ¥µé«˜æ©Ÿç‡ (10x)</option>
                        <option value="50">å¤©é¸ä¹‹äºº (50x)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å„²å­˜å·²æŠ½éçš„æ­·å²åå–®
        let historyList = [];

        function resetHistory() {
            historyList = [];
            document.getElementById('history-count').innerText = "0";
            alert("æ­·å²ç´€éŒ„å·²æ¸…ç©ºï¼Œæ‰€æœ‰äººé‡æ–°åŠ å…¥æŠ½ç±¤ã€‚");
        }

        function luckyDraw() {
            const total = parseInt(document.getElementById('total-students').value);
            const absentStr = document.getElementById('absent-list').value;
            const absent = absentStr ? absentStr.split(',').map(n => parseInt(n.trim())) : [];
            const drawCount = parseInt(document.getElementById('draw-count').value);
            const rule = document.getElementById('draw-rule').value;
            const priorityRange = document.getElementById('priority-range').value;
            const weight = parseInt(document.getElementById('priority-weight').value);
            const isExcludeHistory = document.getElementById('exclude-history').checked;
            
            const resultArea = document.getElementById('result-area');
            const methodDisplay = document.getElementById('method-display');

            let pStart = -1, pEnd = -1;
            if (priorityRange.includes('-')) {
                [pStart, pEnd] = priorityRange.split('-').map(Number);
            }

            // 1. å»ºç«‹ã€ŒæŠ½çç±¤æ¡¶ã€
            let ticketBucket = [];
            for (let i = 1; i <= total; i++) {
                // è·³éç¼ºå¸­
                if (absent.includes(i)) continue; 
                
                // å¦‚æœé–‹å•Ÿäº†æ’é™¤æ­·å²ï¼Œè·³éå·²æŠ½éçš„äºº
                if (isExcludeHistory && historyList.includes(i)) continue;

                let ticketCount = 1;
                if (i >= pStart && i <= pEnd) {
                    ticketCount = weight; 
                }

                for (let t = 0; t < ticketCount; t++) {
                    ticketBucket.push(i);
                }
            }

            // 2. æª¢æŸ¥åé¡æ˜¯å¦è¶³å¤ 
            if (ticketBucket.length === 0) {
                alert("æ²’æœ‰äººå¯ä»¥æŠ½äº†ï¼(å¯èƒ½å·²å…¨éƒ¨æŠ½å®Œæˆ–è¢«è¨­ç‚ºç¼ºå¸­)");
                return;
            }

            let finalResults = [];
            let tempBucket = [...ticketBucket];
            
            // 3. åŸ·è¡ŒæŠ½å–
            while (finalResults.length < drawCount && tempBucket.length > 0) {
                let randomIndex = Math.floor(Math.random() * tempBucket.length);
                let picked = tempBucket[randomIndex];
                
                if (!finalResults.includes(picked)) {
                    finalResults.push(picked);
                    if (isExcludeHistory) historyList.push(picked); // ç´€éŒ„åˆ°æ­·å²
                }
                tempBucket = tempBucket.filter(num => num !== picked);
            }

            // 4. æ›´æ–°ä»‹é¢
            methodDisplay.innerText = "æ­£åœ¨æ–è™Ÿä¸­...";
            resultArea.innerHTML = finalResults.map(() => `<div class="number-circle">?</div>`).join('');

            setTimeout(() => {
                methodDisplay.innerText = "æŠ½å–å®Œæˆï¼";
                resultArea.innerHTML = finalResults.map(num => `<div class="number-circle">${num}</div>`).join('');
                document.getElementById('history-count').innerText = historyList.length;
            }, 800);
        }
    </script>
</body>
</html>
