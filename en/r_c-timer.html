<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>魔術方塊計時器 - LAN Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; 
            color: #c9d1d9; 
            user-select: none; 
        }
        #timer-display {
            font-size: 8rem;
            letter-spacing: -0.05em;
            transition: color 0.1s ease;
        }
        @media (max-width: 768px) {
            #timer-display {
                font-size: 4rem;
            }
        }
        ::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4 md:p-8">

    <div class="flex-grow flex flex-col justify-center items-center">
        <h1 class="text-3xl md:text-4xl font-bold mb-6 text-blue-400">魔術方塊計時器</h1>
        <p id="instruction" class="text-xl mb-12 text-gray-400">
            按下「空白鍵」直到準備就緒，然後「鬆開」開始計時。
        </p>

        <div id="timer-display" class="font-mono font-extrabold text-white">
            0.00
        </div>

        <div id="status-message" class="text-xl mt-4 h-8 text-gray-500">
            就緒 (IDLE)
        </div>

    </div>

    <div class="w-full max-w-4xl mx-auto mt-8 p-4 bg-gray-800 rounded-xl shadow-2xl">
        <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
            <h2 class="text-xl font-semibold text-blue-300">成績歷史記錄</h2>
            <button onclick="clearTimes()" class="bg-red-600 hover:bg-red-700 text-white font-medium py-1 px-3 rounded-lg text-sm transition duration-150">
                清除記錄
            </button>
        </div>
        <div id="times-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
            <p class="text-gray-500 text-sm italic" id="empty-message">目前沒有成績記錄。</p>
        </div>
    </div>

    <script type="text/javascript">
        let timerState = 'IDLE'; 
        let startTime = 0;
        let inspectionTimeout = null;
        let timerInterval = null;
        let currentDisplayTime = 0.00;
        const READY_THRESHOLD = 500;

        const timerDisplay = document.getElementById('timer-display');
        const statusMessage = document.getElementById('status-message');
        const timesList = document.getElementById('times-list');
        const emptyMessage = document.getElementById('empty-message');

        let times = JSON.parse(localStorage.getItem('cube_times')) || [];

        function formatTime(ms) {
            return (ms / 1000).toFixed(2);
        }

        function updateTimerDisplay(ms) {
            currentDisplayTime = ms;
            timerDisplay.textContent = formatTime(ms);
        }


        function startTimer() {
            timerState = 'RUNNING';
            startTime = performance.now();
            statusMessage.textContent = '計時中 (RUNNING)';
            timerDisplay.style.color = 'white';

            timerInterval = setInterval(() => {
                updateTimerDisplay(performance.now() - startTime);
            }, 10); 
        }

        function stopTimer() {
            if (timerState !== 'RUNNING') return;

            clearInterval(timerInterval);
            timerInterval = null;

            timerState = 'STOPPED';
            statusMessage.textContent = '已停止 (STOPPED)';
            timerDisplay.style.color = '#4ade80'; 

            const finalTime = currentDisplayTime;
            times.unshift(finalTime); 

            if (times.length > 100) {
                times.pop();
            }

            localStorage.setItem('cube_times', JSON.stringify(times));

            renderTimes();
        }


        function renderTimes() {
            timesList.innerHTML = '';
            if (times.length === 0) {
                timesList.innerHTML = '<p class="text-gray-500 text-sm italic" id="empty-message">目前沒有成績記錄。</p>';
                return;
            }

            // 計算平均 (Average of 5)
            const ao5 = times.length >= 5
                ? calculateAverage(times.slice(0, 5), 5)
                : '不足 5 筆';

            // 計算平均 (Average of 12)
            const ao12 = times.length >= 12
                ? calculateAverage(times.slice(0, 12), 12)
                : '不足 12 筆';

            const summary = document.createElement('div');
            summary.className = 'text-sm font-medium mb-3 p-2 bg-gray-700 rounded-lg flex justify-around';
            summary.innerHTML = `
                <span class="text-blue-300">最新成績: ${formatTime(times[0])}s</span>
                <span class="text-yellow-300">Avg of 5: ${ao5}</span>
                <span class="text-purple-300">Avg of 12: ${ao12}</span>
            `;
            timesList.appendChild(summary);


            times.forEach((time, index) => {
                const listItem = document.createElement('div');
                listItem.className = 'flex justify-between items-center text-sm p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition duration-100';
                listItem.innerHTML = `
                    <span class="font-mono text-lg">${index + 1}.</span>
                    <span class="font-bold text-xl text-green-400">${formatTime(time)}</span>
                `;
                timesList.appendChild(listItem);
            });
        }

        function calculateAverage(arr, n) {
            if (arr.length < n) return 'N/A';
            const sorted = [...arr].sort((a, b) => a - b);

            const trimmed = sorted.slice(1, n - 1);
            const sum = trimmed.reduce((a, b) => a + b, 0);
            const average = sum / trimmed.length;

            return formatTime(average);
        }

        function clearTimes() {
            if (confirm('確定要清除所有成績記錄嗎？')) {
                times = [];
                localStorage.removeItem('cube_times');
                renderTimes();
                updateTimerDisplay(0);
                timerDisplay.style.color = 'white';
                timerState = 'IDLE';
                statusMessage.textContent = '就緒 (IDLE)';
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.code !== 'Space' || e.repeat) return;
            e.preventDefault(); 

            if (timerState === 'RUNNING') {
                stopTimer();
                return;
            }

            if (timerState === 'IDLE' || timerState === 'STOPPED') {
                timerState = 'INSPECTING';
                statusMessage.textContent = '按住... (HOLDING)';
                timerDisplay.style.color = '#fcd34d'; // 黃色

                inspectionTimeout = setTimeout(() => {
                    timerState = 'READY';
                    statusMessage.textContent = '準備就緒 (READY)';
                    timerDisplay.style.color = '#4ade80'; // 綠色
                }, READY_THRESHOLD);
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.code !== 'Space') return;
            e.preventDefault();

            if (timerState === 'INSPECTING') {
                clearTimeout(inspectionTimeout);
                inspectionTimeout = null;

                timerState = 'IDLE';
                statusMessage.textContent = '就緒 (IDLE)';
                timerDisplay.style.color = 'white';
                return;
            }

            if (timerState === 'READY') {
                clearTimeout(inspectionTimeout);
                inspectionTimeout = null;

                startTimer();
                return;
            }

            if (timerState === 'STOPPED') {
                timerState = 'IDLE';
                statusMessage.textContent = '就緒 (IDLE)';
                updateTimerDisplay(0);
                timerDisplay.style.color = 'white';
            }
        });

        window.onload = () => {
            renderTimes();
        };
    </script>
    <script type="module" src="navbar.js"></script></body>
</body>
</html>
