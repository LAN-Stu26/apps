<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Editor - LAN Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --editor-bg: #1e1e1e;
            --header-bg: #252526;
            --border-color: #3c3c3c;
            --accent: #ffd966;
            --text-gray: #cccccc;
            --tab-active: #1e1e1e;
            --tab-inactive: #2d2d2d;
        }

        body, html { margin: 0; padding: 0; height: 100%; background-color: var(--editor-bg); font-family: 'Noto Sans TC', sans-serif; overflow: hidden; }

        /* --- é®ç½©èˆ‡å°è¦½åˆ—é ç•™ --- */
        #auth-overlay, #mobile-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(18, 18, 18, 0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; text-align: center; backdrop-filter: blur(5px); }
        .overlay-card { background: #2d2d2d; padding: 40px; border-radius: 20px; border: 1px solid var(--border-color); }

        /* --- å¤šæ¨™ç±¤ç³»çµ± --- */
        .tabs { display: flex; background: var(--header-bg); border-bottom: 1px solid var(--border-color); padding-left: 10px; }
        .tab { padding: 10px 20px; color: var(--text-gray); font-size: 13px; cursor: pointer; background: var(--tab-inactive); border: 1px solid var(--border-color); border-bottom: none; margin-right: 5px; border-radius: 5px 5px 0 0; transition: 0.2s; }
        .tab.active { background: var(--tab-active); color: var(--accent); border-top: 2px solid var(--accent); }

        /* --- å·¥ä½œå€ --- */
        .workspace { display: flex; height: calc(100vh - 105px); margin-top: 60px; }
        .editor-pane, .preview-pane { flex: 1; display: flex; flex-direction: column; min-width: 300px; }
        
        /* --- è¡Œè™Ÿç³»çµ± --- */
        .editor-container { flex: 1; display: flex; background: var(--editor-bg); overflow: hidden; position: relative; }
        .line-numbers { width: 40px; padding: 20px 5px; background: #252526; color: #858585; text-align: right; font-family: 'Fira Code', monospace; font-size: 15px; line-height: 1.6; user-select: none; border-right: 1px solid var(--border-color); overflow: hidden; }
        
        #code-input {
            flex: 1; background: transparent; color: #d4d4d4; border: none; padding: 20px;
            font-family: 'Fira Code', monospace; font-size: 15px; outline: none; resize: none; 
            line-height: 1.6; white-space: pre; overflow: auto;
        }

        /* --- æ§åˆ¶åˆ— --- */
        .pane-header { background: var(--header-bg); color: var(--text-gray); padding: 8px 15px; font-size: 13px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .btn-group { display: flex; gap: 8px; }
        .btn-action { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-action:hover { background: var(--accent); color: #000; }

        #preview-iframe { flex: 1; background: white; border: none; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="overlay-card">
            <h1 style="color: var(--accent);">ğŸ”’ ç™»å…¥ä»¥è§£é–å¤šæª”æ¡ˆæ¨™ç±¤</h1>
            <p style="color: #aaa;">éæœƒå“¡åƒ…èƒ½ç·¨è¼¯å–®ä¸€ index.html æª”æ¡ˆã€‚</p>
            <button style="padding:10px 20px; cursor:pointer;" onclick="document.getElementById('auth-overlay').style.display='none'">æš«æ™‚é«”é©—</button>
        </div>
    </div>

    <div class="tabs" id="editor-tabs" style="margin-top: 60px; display: none;">
        <div class="tab active" onclick="switchTab('html')">index.html</div>
        <div class="tab" id="css-tab" onclick="switchTab('css')">style.css</div>
        <div class="tab" id="js-tab" onclick="switchTab('js')">script.js</div>
    </div>

    <main class="workspace" id="main-workspace">
        <section class="editor-pane">
            <div class="pane-header">
                <span id="current-filename">index.html</span>
                <div class="btn-group">
                    <button class="btn-action" onclick="triggerImport()">åŒ¯å…¥æª”æ¡ˆ</button>
                    <button class="btn-action" onclick="downloadCode()">ä¸‹è¼‰æª”æ¡ˆ</button>
                </div>
            </div>
            <div class="editor-container">
                <div class="line-numbers" id="line-numbers">1</div>
                <textarea id="code-input" spellcheck="false" wrap="off"></textarea>
            </div>
            <input type="file" id="file-import" style="display: none;" accept=".html,.css,.js">
        </section>

        <section class="preview-pane">
            <div class="pane-header">å³æ™‚é è¦½ (Live View)</div>
            <iframe id="preview-iframe"></iframe>
        </section>
    </main>

    <script type="module" src="navbar.js"></script>
    <script type="module">
        import { auth } from './navbar.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const codeInput = document.getElementById('code-input');
        const lineNumbers = document.getElementById('line-numbers');
        const previewIframe = document.getElementById('preview-iframe');
        const tabsEl = document.getElementById('editor-tabs');
        
        // æª”æ¡ˆå…§å®¹å„²å­˜
        let files = {
            html: `<!DOCTYPE html>\n<html>\n<head>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <h1>LAN Studio IDE</h1>\n  <p>è©¦è‘—åˆ‡æ›æ¨™ç±¤æˆ–åŒ¯å…¥æª”æ¡ˆï¼</p>\n  <script src="script.js"><\/script>\n</body>\n</html>`,
            css: `body { background: #f4f4f4; text-align: center; font-family: sans-serif; transition: 0.5s; }\nh1 { color: #3498db; }`,
            js: `console.log("Hello from LAN Studio!");\n// é»æ“Šæ¨™é¡Œæœƒè®Šè‰²\ndocument.querySelector('h1').onclick = () => {\n  document.body.style.background = '#ffd966';\n};`
        };
        let currentTab = 'html';

        // --- 1. è¡Œè™Ÿé¡¯ç¤ºé‚è¼¯ ---
        function updateLineNumbers() {
            const lines = codeInput.value.split('\n').length;
            lineNumbers.innerHTML = Array.from({length: lines}, (_, i) => i + 1).join('<br>');
        }

        // åŒæ­¥æ²å‹•
        codeInput.onscroll = () => {
            lineNumbers.scrollTop = codeInput.scrollTop;
        };

        // --- 2. æ¨™ç±¤åˆ‡æ›é‚è¼¯ ---
        window.switchTab = (type) => {
            files[currentTab] = codeInput.value; // å„²å­˜èˆŠå…§å®¹
            currentTab = type;
            
            // æ›´æ–° UI
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('current-filename').innerText = `index.${type}`;
            
            codeInput.value = files[type];
            updateLineNumbers();
        };

        // --- 3. åŒ¯å…¥é‚è¼¯ ---
        window.triggerImport = () => document.getElementById('file-import').click();
        document.getElementById('file-import').onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (res) => {
                codeInput.value = res.target.result;
                updatePreview();
                updateLineNumbers();
            };
            reader.readAsText(file);
        };

        // --- 4. é è¦½æ¸²æŸ“ (æ•´åˆ HTML/CSS/JS) ---
        function updatePreview() {
            if (currentTab !== 'html') files[currentTab] = codeInput.value;
            
            let combinedCode = files.html;
            // å°‡ CSS æ³¨å…¥
            combinedCode = combinedCode.replace('<link rel="stylesheet" href="style.css">', `<style>${files.css}</style>`);
            // å°‡ JS æ³¨å…¥
            combinedCode = combinedCode.replace('<script src="script.js"><\/script>', `<script>${files.js}<\/script>`);
            
            previewIframe.srcdoc = combinedCode;
            updateLineNumbers();
        }

        // --- 5. æ¬Šé™æª¢æŸ¥ ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                tabsEl.style.display = 'flex';
                document.getElementById('main-workspace').style.marginTop = '0';
            } else {
                document.getElementById('auth-overlay').style.display = 'flex';
            }
            codeInput.value = files.html;
            updatePreview();
        });

        window.downloadCode = () => {
            const blob = new Blob([codeInput.value], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `index.${currentTab}`;
            a.click();
        };

        codeInput.addEventListener('input', updatePreview);
    </script>
</body>
</html>
