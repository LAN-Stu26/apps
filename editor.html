<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional IDE - LAN Studio</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --editor-bg: #1e1e1e; --header-bg: #252526; --border-color: #3c3c3c;
            --accent: #ffd966; --text-gray: #cccccc; --safe-green: #2ecc71;
        }

        body, html { margin: 0; padding: 0; height: 100%; background-color: var(--editor-bg); font-family: 'Noto Sans TC', sans-serif; overflow: hidden; }

        /* --- é ‚éƒ¨å°è¦½èˆ‡åŒæ­¥ --- */
        .top-nav { display: flex; align-items: center; background: var(--header-bg); border-bottom: 1px solid var(--border-color); margin-top: 60px; height: 40px; padding: 0 10px; }
        
        /* --- æ¨™ç±¤æ¨£å¼ï¼šç·Šæ¹Šç„¡ç©ºç™½ --- */
        .tabs { display: flex; height: 100%; align-items: flex-end; }
        .tab { 
            padding: 0 15px; height: 32px; display: flex; align-items: center; 
            color: #999; font-size: 13px; cursor: pointer; background: #2d2d2d;
            border: 1px solid var(--border-color); border-bottom: none; margin-right: 2px;
            border-radius: 5px 5px 0 0; transition: 0.2s; position: relative;
        }
        .tab.active { background: var(--editor-bg); color: var(--accent); border-top: 2px solid var(--accent); }
        .tab .edit-icon { margin-left: 8px; font-size: 10px; opacity: 0.5; }
        .tab:hover .edit-icon { opacity: 1; }

        /* --- å·¥ä½œå€ä½ˆå±€ï¼šæ¶ˆé™¤é–“éš™ --- */
        .workspace { display: flex; height: calc(100vh - 100px); width: 100%; background: var(--editor-bg); }
        .editor-pane { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }
        .editor-container { flex: 1; display: flex; overflow: hidden; }
        
        .line-numbers { 
            width: 45px; padding: 20px 0; background: #1e1e1e; color: #666; 
            text-align: right; font-family: 'Fira Code', monospace; font-size: 14px; 
            line-height: 1.6; border-right: 1px solid #333; overflow: hidden; padding-right: 10px;
        }

        #code-input { 
            flex: 1; background: transparent; color: #d4d4d4; border: none; padding: 20px; 
            font-family: 'Fira Code', monospace; font-size: 14px; outline: none; 
            resize: none; line-height: 1.6; white-space: pre; overflow: auto; 
        }

        /* é è¦½å€ */
        .preview-pane { flex: 1; background: #fff; }
        #preview-iframe { width: 100%; height: 100%; border: none; background: white; }

        /* åŒæ­¥é–‹é—œ */
        .sync-control { margin-left: auto; display: flex; align-items: center; gap: 8px; font-size: 11px; color: #888; }
        .switch { position: relative; display: inline-block; width: 30px; height: 16px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 10px; width: 10px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--safe-green); }
        input:checked + .slider:before { transform: translateX(14px); }

        #privacy-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; z-index: 30000; justify-content: center; align-items: center; }
        .modal-content { background: #2d2d2d; padding: 25px; border-radius: 12px; border: 1px solid var(--accent); max-width: 400px; }
    </style>
</head>
<body>

    <div id="privacy-modal">
        <div class="modal-content">
            <h3 style="color:var(--accent); margin-top:0;">ğŸ” é›²ç«¯åŠ å¯†åŒæ­¥</h3>
            <p style="color:#eee; font-size: 14px;">é–‹å•Ÿå¾Œï¼Œä»£ç¢¼å°‡ä»¥ AES-256 åŠ å¯†å­˜å„²ã€‚æˆ‘å€‘ç„¡æ³•è®€å–æ‚¨çš„åŸå§‹ç¢¼ï¼Œç¢ºä¿æ‚¨çš„æŠ€è¡“ä¸å¤–æµã€‚</p>
            <div style="text-align:right;">
                <button onclick="confirmPrivacy(false)" style="background:none; border:none; color:#888; cursor:pointer;">å–æ¶ˆ</button>
                <button onclick="confirmPrivacy(true)" style="background:var(--accent); border:none; padding:6px 15px; border-radius:4px; cursor:pointer; margin-left:10px;">åŒæ„ä¸¦åŒæ­¥</button>
            </div>
        </div>
    </div>

    <div class="top-nav">
        <div class="tabs" id="tab-list">
            </div>
        <div class="sync-control">
            <span id="sync-text">æœ¬åœ°æ¨¡å¼</span>
            <label class="switch">
                <input type="checkbox" id="sync-toggle">
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <main class="workspace">
        <div class="editor-pane">
            <div class="editor-container">
                <div class="line-numbers" id="line-numbers">1</div>
                <textarea id="code-input" spellcheck="false" wrap="off" placeholder="åœ¨æ­¤è¼¸å…¥ä»£ç¢¼..."></textarea>
            </div>
        </div>
        <div class="preview-pane">
            <iframe id="preview-iframe"></iframe>
        </div>
    </main>

    <script type="module" src="navbar.js"></script>
    <script type="module">
        import { auth } from './navbar.js';
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const db = getFirestore();
        const codeInput = document.getElementById('code-input');
        const lineNumbers = document.getElementById('line-numbers');
        const previewIframe = document.getElementById('preview-iframe');
        const tabList = document.getElementById('tab-list');
        const syncToggle = document.getElementById('sync-toggle');

        // æ ¸å¿ƒè³‡æ–™çµæ§‹
        let files = [
            { id: 0, name: 'index.html', content: '<h1>Hello LAN!</h1>', type: 'html' },
            { id: 1, name: 'style.css', content: 'h1 { color: gold; }', type: 'css' },
            { id: 2, name: 'script.js', content: 'console.log("IDE Ready");', type: 'js' }
        ];
        let activeFileId = 0;
        let isSyncEnabled = false;

        // --- 1. æ¨™ç±¤è‡ªå®šç¾©åŠŸèƒ½ ---
        function renderTabs() {
            tabList.innerHTML = '';
            files.forEach(file => {
                const tab = document.createElement('div');
                tab.className = `tab ${file.id === activeFileId ? 'active' : ''}`;
                tab.innerHTML = `${file.name} <span class="edit-icon">âœ</span>`;
                tab.onclick = () => switchFile(file.id);
                tab.ondblclick = () => renameFile(file.id); // é›™æ“Šé‡å‘½å
                tabList.appendChild(tab);
            });
        }

        function renameFile(id) {
            const newName = prompt("è«‹è¼¸å…¥æ–°çš„æª”æ¡ˆåç¨±ï¼š", files[id].name);
            if (newName) {
                files[id].name = newName;
                renderTabs();
            }
        }

        function switchFile(id) {
            // å…ˆå„²å­˜ç•¶å‰ç·¨è¼¯å…§å®¹
            const currentFile = files.find(f => f.id === activeFileId);
            currentFile.content = codeInput.value;
            
            activeFileId = id;
            const nextFile = files.find(f => f.id === id);
            codeInput.value = nextFile.content;
            renderTabs();
            updateLineNumbers();
        }

        // --- 2. çœŸæ­£å³æ™‚é è¦½ (Blob æ¸²æŸ“) ---
        function updatePreview() {
            // æ›´æ–°ç•¶å‰æª”æ¡ˆç‰©ä»¶å…§å®¹
            files.find(f => f.id === activeFileId).content = codeInput.value;

            const htmlFile = files.find(f => f.type === 'html').content;
            const cssFile = files.find(f => f.type === 'css').content;
            const jsFile = files.find(f => f.type === 'js').content;

            const finalCode = `
                <!DOCTYPE html>
                <html>
                <head><style>${cssFile}</style></head>
                <body>
                    ${htmlFile}
                    <script>${jsFile}<\/script>
                </body>
                </html>
            `;

            // ä½¿ç”¨ Blob ç¢ºä¿å¤§æª”æ¡ˆä¹Ÿèƒ½å³æ™‚æ¸²æŸ“ä¸”ä¸é–ƒçˆ
            const blob = new Blob([finalCode], { type: 'text/html' });
            previewIframe.src = URL.createObjectURL(blob);
            updateLineNumbers();
            
            if (isSyncEnabled) triggerCloudSave();
        }

        // --- 3. ç•Œé¢å„ªåŒ– ---
        function updateLineNumbers() {
            const lines = codeInput.value.split('\n').length;
            lineNumbers.innerHTML = Array.from({length: lines}, (_, i) => i + 1).join('<br>');
        }

        // --- ğŸ”’ åŠ å¯†èˆ‡åŒæ­¥é‚è¼¯ ---
        const encrypt = (t, k) => CryptoJS.AES.encrypt(t, k).toString();
        const decrypt = (c, k) => { try { return CryptoJS.AES.decrypt(c, k).toString(CryptoJS.enc.Utf8); } catch { return ""; }};

        let saveTimeout;
        function triggerCloudSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                if (!isSyncEnabled || !auth.currentUser) return;
                const key = auth.currentUser.uid;
                await setDoc(doc(db, "user_ide", key), {
                    payload: encrypt(JSON.stringify(files), key),
                    updatedAt: serverTimestamp()
                });
            }, 1000);
        }

        syncToggle.onchange = (e) => {
            if (e.target.checked && !isSyncEnabled) {
                document.getElementById('privacy-modal').style.display = 'flex';
                e.target.checked = false;
            } else if (!e.target.checked) {
                isSyncEnabled = false;
                document.getElementById('sync-text').innerText = "æœ¬åœ°æ¨¡å¼";
            }
        };

        window.confirmPrivacy = (agreed) => {
            document.getElementById('privacy-modal').style.display = 'none';
            if (agreed) {
                isSyncEnabled = true;
                syncToggle.checked = true;
                document.getElementById('sync-text').innerText = "é›²ç«¯åŠ å¯†ä¸­";
                triggerCloudSave();
            }
        };

        // åˆå§‹åŒ–
        codeInput.addEventListener('input', updatePreview);
        codeInput.onscroll = () => lineNumbers.scrollTop = codeInput.scrollTop;
        
        onAuthStateChanged(auth, (user) => {
            renderTabs();
            updatePreview();
        });
    </script>
</body>
</html>
